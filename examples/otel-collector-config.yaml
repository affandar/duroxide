# OpenTelemetry Collector Configuration for Duroxide
#
# This configuration receives metrics and logs from duroxide via OTLP
# and exports them to various backends.
#
# Start the collector:
#   docker run -p 4317:4317 -v $(pwd)/otel-collector-config.yaml:/etc/otel-collector-config.yaml \
#     otel/opentelemetry-collector:latest --config=/etc/otel-collector-config.yaml

receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

processors:
  batch:
    timeout: 10s
    send_batch_size: 1024

  # Add resource attributes
  resource:
    attributes:
      - key: service.name
        value: duroxide
        action: upsert

  # Filter out debug/trace logs if needed
  filter/logs:
    logs:
      exclude:
        match_type: regexp
        resource_attributes:
          - key: level
            value: (DEBUG|TRACE)

exporters:
  # Prometheus metrics export
  prometheus:
    endpoint: "0.0.0.0:8889"
    namespace: duroxide

  # Logging to stdout for debugging
  logging:
    verbosity: detailed
    sampling_initial: 5
    sampling_thereafter: 200

  # Elasticsearch for logs
  elasticsearch:
    endpoints: ["http://elasticsearch:9200"]
    logs_index: duroxide-logs
    metrics_index: duroxide-metrics
    timeout: 30s

  # Loki for logs
  loki:
    endpoint: http://loki:3100/loki/api/v1/push
    labels:
      attributes:
        service.name: "service_name"
      resource:
        service.name: "service_name"

  # AWS CloudWatch (uncomment if using AWS)
  # awscloudwatch:
  #   region: us-east-1
  #   log_group_name: /duroxide/logs
  #   log_stream_name: duroxide-worker

  # Azure Monitor (uncomment if using Azure)
  # azuremonitor:
  #   instrumentation_key: YOUR_INSTRUMENTATION_KEY
  #   maxbatchsize: 1024
  #   maxbatchinterval: 10s

service:
  pipelines:
    # Metrics pipeline
    metrics:
      receivers: [otlp]
      processors: [batch, resource]
      exporters: [prometheus, logging]

    # Logs pipeline
    logs:
      receivers: [otlp]
      processors: [batch, resource]
      exporters: [logging, elasticsearch, loki]

  # Extensions for health checks and diagnostics
  extensions: []

# Optional: Add extensions for health monitoring
# extensions:
#   health_check:
#     endpoint: 0.0.0.0:13133
#   pprof:
#     endpoint: 0.0.0.0:1777
#   zpages:
#     endpoint: 0.0.0.0:55679

